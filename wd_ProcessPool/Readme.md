# wd_ProcessPool - 基于Epoll的Web文件服务器

## 项目概述

wd_ProcessPool是一个基于Linux epoll机制的高性能Web文件服务器，采用进程池架构设计。该项目展示了如何使用epoll事件驱动模型结合进程池技术来构建一个并发Web服务器，主要用于文件传输服务。

## 项目特点

- **事件驱动架构**: 基于epoll实现高效的I/O多路复用
- **进程池模式**: 预创建固定数量的工作进程处理客户端请求
- **文件描述符传递**: 使用Unix域套接字传递客户端连接
- **优雅退出**: 支持信号处理和进程间协调退出
- **模块化设计**: 功能模块清晰分离，代码结构简洁

## 项目架构

### 整体架构

```
┌─────────────────┐
│   主进程(Master) │
│   - epoll事件循环 │
│   - 连接分发     │
│   - 进程管理     │
└─────────┬───────┘
          │
    ┌─────┴─────┐
    │ socketpair │ (进程间通信)
    └─────┬─────┘
          │
┌─────────┴───────┐
│   工作进程池     │
│ ┌─────┐ ┌─────┐ │
│ │Worker│ │Worker│ │
│ │  1   │ │  2   │ │
│ └─────┘ └─────┘ │
│ ┌─────┐ ┌─────┐ │
│ │Worker│ │Worker│ │
│ │  3   │ │  4   │ │
│ └─────┘ └─────┘ │
└─────────────────┘
```

### 核心组件

1. **主进程(Master Process)**
   - 监听客户端连接
   - 管理工作进程状态
   - 分发连接到空闲工作进程
   - 处理信号和优雅退出

2. **工作进程(Worker Process)**
   - 处理具体的客户端请求
   - 执行文件传输任务
   - 与主进程通信状态变化

3. **进程间通信(IPC)**
   - 使用socketpair创建本地套接字对
   - 通过sendmsg/recvmsg传递文件描述符
   - 支持控制消息和数据传输

## 代码结构

```
wd_ProcessPool/
├── serve/                 # 服务器端代码
│   ├── head.h            # 头文件和函数声明 (64行)
│   ├── main.c            # 主程序入口 (89行)
│   ├── pool.c            # 进程池管理 (68行)
│   ├── worker.c          # 工作进程逻辑 (47行)
│   ├── epoll.c           # epoll事件处理 (17行)
│   ├── socket.c          # 套接字操作 (24行)
│   ├── local.c           # 本地套接字通信 (74行)
│   ├── sendFile.c        # 文件传输功能
│   ├── config.ini        # 配置文件
│   └── Makefile          # 构建脚本
├── client/               # 客户端代码
│   ├── client.c          # 客户端实现
│   └── Makefile          # 客户端构建脚本
└── Readme.md            # 项目文档
```

### 代码量统计

| 文件 | 行数 | 功能描述 |
|------|------|----------|
| head.h | 64 | 头文件定义和函数声明 |
| main.c | 89 | 主程序逻辑和事件循环 |
| pool.c | 68 | 进程池初始化和管理 |
| worker.c | 47 | 工作进程核心逻辑 |
| local.c | 74 | 进程间通信实现 |
| socket.c | 24 | 网络套接字操作 |
| epoll.c | 17 | epoll事件处理 |
| sendFile.c | ~50 | 文件传输功能 |
| **总计** | **~433** | **核心服务器代码** |

## 核心技术特性

### 1. Epoll事件驱动

```c
// epoll事件循环
int epoll_fd = epoll_create(1);
struct epoll_event events[10];
int epoll_num = epoll_wait(epoll_fd, events, 10, -1);
```

**优势:**
- 高效的I/O多路复用
- 支持大量并发连接
- 事件驱动，避免轮询开销

### 2. 进程池架构

```c
// 进程状态管理
typedef struct son_status_s{
    pid_t pid;              // 子进程ID
    int flag;               // 进程状态(BUSY/FREE)
    int local_socket;       // 通信套接字
} son_status_t;
```

**特点:**
- 预创建固定数量工作进程(4个)
- 避免频繁创建/销毁进程的开销
- 简单的负载均衡策略

### 3. 文件描述符传递

```c
// 使用sendmsg传递文件描述符
struct msghdr msg;
struct cmsghdr *cms;
cms->cmsg_type = SCM_RIGHTS;
sendmsg(local_socket, &msg, 0);
```

**优势:**
- 高效的连接分发机制
- 避免数据复制开销
- 支持跨进程资源共享

### 4. 信号处理和优雅退出

```c
// 信号处理函数
void func2(int num){
    write(pipe_fd[1], "1", 1);  // 通过管道通知主循环
}
```

**特点:**
- 支持SIGINT信号处理
- 协调所有进程优雅退出
- 资源清理和状态同步

## 使用方法

### 编译和运行

```bash
# 编译服务器
cd serve
make

# 编译客户端
cd ../client
make

# 运行服务器
./server

# 运行客户端
./client
```

### 配置说明

- **IP地址**: 192.168.106.130 (在main.c中配置)
- **端口**: 8080
- **工作进程数**: 4个
- **最大连接数**: 由epoll支持的最大文件描述符数决定

## 性能特点

### 优势

1. **高并发支持**: epoll机制支持大量并发连接
2. **低延迟**: 事件驱动避免不必要的轮询
3. **资源效率**: 进程池避免频繁创建销毁进程
4. **稳定性**: 进程隔离提供良好的容错性

### 性能指标

- **并发连接数**: 理论上支持数万个连接
- **工作进程数**: 固定4个
- **内存占用**: 较低，主要是进程基础开销
- **CPU使用**: 事件驱动模式下CPU使用效率较高

## 改进建议

### 1. 动态进程池管理

**当前限制**: 固定4个工作进程

**改进方案**:
```c
// 动态调整进程池大小
typedef struct {
    int min_workers;     // 最小工作进程数
    int max_workers;     // 最大工作进程数
    int current_workers; // 当前工作进程数
    float load_threshold; // 负载阈值
} dynamic_pool_config_t;
```

### 2. 配置文件支持

**当前限制**: 硬编码配置参数

**改进方案**:
```ini
# config.ini
[server]
ip = 0.0.0.0
port = 8080
worker_count = 4
max_connections = 1000

[performance]
epoll_timeout = 1000
buffer_size = 4096
```

### 3. 日志系统

**当前限制**: 简单的printf输出

**改进方案**:
```c
// 结构化日志系统
typedef enum {
    LOG_DEBUG, LOG_INFO, LOG_WARN, LOG_ERROR
} log_level_t;

void log_write(log_level_t level, const char* format, ...);
```

### 4. 性能监控

**改进方案**:
```c
// 性能指标收集
typedef struct {
    uint64_t total_connections;
    uint64_t active_connections;
    uint64_t bytes_transferred;
    double avg_response_time;
} server_metrics_t;
```

### 5. 错误处理增强

**当前限制**: 基础的错误处理

**改进方案**:
- 完善的错误码定义
- 错误恢复机制
- 异常情况下的资源清理
- 详细的错误日志记录

### 6. HTTP协议支持

**当前限制**: 简单的文件传输

**改进方案**:
- 完整的HTTP/1.1协议支持
- 请求解析和响应生成
- 支持多种MIME类型
- Keep-Alive连接复用

### 7. 内存管理优化

**改进方案**:
```c
// 内存池管理
typedef struct {
    void* pool_start;
    size_t pool_size;
    size_t used_size;
    struct block* free_blocks;
} memory_pool_t;
```

### 8. 安全性增强

**改进方案**:
- 输入验证和过滤
- 缓冲区溢出防护
- 访问控制和权限管理
- SSL/TLS加密支持

## 技术对比

### 与传统多线程服务器对比

| 特性 | wd_ProcessPool | 多线程服务器 |
|------|----------------|-------------|
| 并发模型 | 多进程 + epoll | 多线程 |
| 内存隔离 | ✅ 进程隔离 | ❌ 共享内存空间 |
| 容错性 | ✅ 进程崩溃不影响其他 | ❌ 线程崩溃影响整个进程 |
| 资源开销 | 较高(进程开销) | 较低(线程开销) |
| 扩展性 | 受进程数限制 | 受线程数限制 |
| 调试难度 | 中等 | 较高(竞态条件) |

### 与异步I/O框架对比

| 特性 | wd_ProcessPool | Node.js/异步框架 |
|------|----------------|------------------|
| 编程模型 | 同步编程 | 异步回调/Promise |
| CPU利用 | 多核并行 | 单线程事件循环 |
| 内存使用 | 较高 | 较低 |
| 开发复杂度 | 中等 | 较高(异步编程) |
| 性能特点 | CPU密集型友好 | I/O密集型友好 |

## 学习价值

### 适合学习的技术点

1. **Linux系统编程**
   - epoll事件驱动编程
   - 进程创建和管理
   - 信号处理机制
   - Unix域套接字通信

2. **网络编程**
   - TCP套接字编程
   - 文件描述符传递
   - 非阻塞I/O操作
   - 网络协议实现

3. **并发编程**
   - 进程池设计模式
   - 负载均衡策略
   - 进程间同步
   - 资源管理

4. **系统架构**
   - Master-Worker模式
   - 事件驱动架构
   - 模块化设计
   - 性能优化思路

## 适用场景

### 推荐使用场景

- **教学和学习**: 理解Web服务器基本原理
- **原型开发**: 快速构建文件服务器原型
- **小规模应用**: 内网文件共享服务
- **技术验证**: 验证epoll和进程池技术

### 不推荐场景

- **生产环境**: 缺乏完善的错误处理和监控
- **高并发场景**: 固定进程数限制扩展性
- **复杂HTTP应用**: 协议支持有限
- **安全敏感应用**: 缺乏安全防护机制

## 总结

wd_ProcessPool是一个优秀的学习型Web服务器项目，展示了epoll事件驱动和进程池技术的结合使用。虽然功能相对简单，但架构清晰，代码易读，非常适合用于学习Linux系统编程和网络编程的基本概念。

通过适当的改进和扩展，该项目可以发展成为一个功能完善的Web服务器，具有很好的教学价值和实践意义。

## 许可证

本项目仅供学习和研究使用。

## 联系方式

如有问题或建议，请通过相关渠道联系项目维护者。